# Two Factor Totp
![Downloads](https://img.shields.io/github/downloads/nextcloud/twofactor_totp/total.svg)
[![Build Status](https://travis-ci.org/nextcloud/twofactor_totp.svg?branch=master)](https://travis-ci.org/nextcloud/twofactor_totp)

[![Sauce Test Status](https://saucelabs.com/browser-matrix/nextcloud-totp.svg)](https://saucelabs.com/u/nextcloud-totp)

Tested with the following apps:
* [Aegis](https://github.com/beemdevelopment/Aegis) (open source) Available via [F-Droid](https://f-droid.org/en/packages/com.beemdevelopment.aegis/) and [Google Play](https://play.google.com/store/apps/details?id=com.beemdevelopment.aegis). It features a built-in QR-code reader.
* [FreeOTPPlus](https://github.com/helloworld1/FreeOTPPlus/) (open source) Availabe via [F-droid](https://f-droid.org/packages/org.liberty.android.freeotpplus/) and [Google Play](https://play.google.com/store/apps/details?id=org.liberty.android.freeotpplus).
* [OTP Authenticator](https://github.com/0xbb/otp-authenticator) (open source) Availabe via [F-Droid](https://f-droid.org/en/packages/net.bierbaumer.otp_authenticator/) and [Google Play](https://play.google.com/store/apps/details?id=net.bierbaumer.otp_authenticator). It features a built-in QR-code reader.
* [Google Authenticator](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2) (proprietary)
* [KeePassXC (Linux, Windows, macOS)](https://keepassxc.org/) (open-source) Available via [download](https://keepassxc.org/download/), package repositories or [GitHub](http://www.github.com/keepassxreboot/keepassxc/) (Keepass also provides a plugin and Keepass2Android allows to use TOTP token)
* [SailOTP (SailfishOS)](https://github.com/seiichiro0185/sailotp) (open source) Available via JollaStore or [Openrepos.net](https://openrepos.net/content/seiichiro0185/sailotp)
* [OTP Auth](https://cooperrs.de/otpauth.html) (proprietary) Availabe via [Apple's App Store](https://itunes.apple.com/us/app/otp-auth/id659877384)
* [Authy (Twilio Authy)](https://authy.com/) (proprietary) for Android and IOS. Availabe via [Google Play](https://play.google.com/store/apps/details?id=com.authy.authy) and [Apple's App Store](https://apps.apple.com/de/app/twilio-authy/id494168017)

Tested with the following hardware devices:
* [Nitrokey Pro](https://shop.nitrokey.com/shop/product/nitrokey-pro-2-3)
* [Nitrokey Storage](https://shop.nitrokey.com/shop)

## Installation

### Nextcloud 25 and newer

The app is [shipped](https://docs.nextcloud.com/server/latest/developer_manual/app_publishing_maintenance/release_process.html#shipped-apps) and comes with the installation of Nextcloud Server. No additional steps are necessary.

### Nextcloud 24 and older

The app is available through the [app store](https://apps.nextcloud.com/apps/twofactor_totp). It can be [installed through Nextcloud's app management UI](https://docs.nextcloud.com/server/latest/admin_manual/apps_management.html#managing-apps).

## Enabling TOTP 2FA for your account
![](screenshots/enter_challenge.png)
![](screenshots/settings.png)

## Setting options for security hardening

The secret generated by this application is 32 characters long and includes only the characters A-Z and the numbers 2, 3, 4, 5, 6, and 7 ([RFC 4648 Base32 alphabet](https://datatracker.ietf.org/doc/html/rfc4648#section-6)), meeting the recommended 160-bit depth by [RFC 4226](https://datatracker.ietf.org/doc/html/rfc4226#section-4).

Every 30 seconds, a 6-character numeric one-time password (OTP) is generated using the SHA-1 hash algorithm on both - the server and the TOTP authenticator app on your smartphone /-device. So whoever has the secret can get access to the second factor. That's why TOTP apps are (should be) usually very well secured. 

### Configurable options by admin

1. **Secret Length:**
    ||characters|bits|
    |-|-|-|
    |Default:|32|160
    |Minimum:|26|130
    |Maximum:|128|640

    Adjust the default secret length using the number of characters as value:

    ```sh
    occ config:app:set --value=64 -- twofactor_totp secret_length
    ```

2. **Hash Algorithm:**
    ||algorithm|key|
    |-|-|-|
    |Default:|SHA1|1
    |Optional:|SHA256|2
    |Optional:|SHA512|3

    Adjust the default algorithm using the key as value:

    ```sh
    occ config:app:set --value=3 -- twofactor_totp hash_algorithm
    ```

3. **Token Length:**

    ||digits|
    |-|-|
    |Default:|6
    |Maximum:|8

    Adjust the default token length of the OTP using the number of digits as value:

    ```sh
    occ config:app:set --value=8 -- twofactor_totp token_length
    ```

### Configurable options by user

During activation and setup by the user, a QR code is generated with the secret based on the default values as described here. By scanning that QR code with any TOTP app, the secret can be immediately activated with the first matching OTP. An "Advanced Settings" button gives the user access to further setting options that go beyond the default values:

* Own secret
* Token length in a range from 4 to 10
* Validity period of the OTP from 15 to 60 seconds

Not all apps can use all of these setting options or not to this extent, so these values cannot be set by the admin by default, otherwise only a small number of TOTP apps would be compatible.

If an app does not support a setting, then either the generated QR code is not accepted by the app, there may be an error message, or the first OTP is incorrect and the secret cannot be activated. It can be varied until a QR code works.

## Login with external apps
Once you enable OTP with Two Factor Totp, your aplications (for example your Android app or your GNOME app) will need to login using device passwords. To manage it, [know more here](https://docs.nextcloud.com/server/stable/user_manual/en/session_management.html#managing-devices)

## Development setup

* `composer i`
* `npm ci`
* `npm run build` or `npm run dev` [more info](https://docs.nextcloud.com/server/latest/developer_manual/digging_deeper/npm.html)

